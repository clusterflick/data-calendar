on:
  workflow_dispatch:
  repository_dispatch:
    types: [release_event]

name: Generate Calendar

jobs:
  generate_calendar:
    name: Generate and Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm install

      - name: Check API Rate Limit
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          RATE_LIMIT=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/rate_limit)
          REMAINING=$(echo "$RATE_LIMIT" | jq '.resources.core.remaining')
          LIMIT=$(echo "$RATE_LIMIT" | jq '.resources.core.limit')
          RESET_TIME=$(echo "$RATE_LIMIT" | jq '.resources.core.reset')
          SECONDS_UNTIL_RESET=$((RESET_TIME - $(date +%s)))
          MINS=$((SECONDS_UNTIL_RESET / 60))
          SECS=$((SECONDS_UNTIL_RESET % 60))
          echo "ðŸ“Š Rate limit: $REMAINING/$LIMIT remaining"
          echo "â° Resets in ${MINS}m ${SECS}s ($(date -d @$RESET_TIME '+%H:%M:%S %Z'))"

      - uses: robinraju/release-downloader@v1
        with:
          token: ${{ secrets.PAT }}
          repository: "clusterflick/data-transformed"
          latest: true
          fileName: "*"
          out-file-path: "transformed-data"

      - name: Generate Calendar
        run: npm run generate-calendar

      - name: Generate Tag
        run: echo "TAG=$(TZ=Europe/London date +'%Y%m%d.%H%M%S')" >> $GITHUB_ENV
      - uses: ncipollo/release-action@v1
        id: release
        with:
          allowUpdates: false
          artifactErrorsFailBuild: true
          artifacts: "calendar-data/*"
          makeLatest: true
          tag: ${{ env.TAG }}
          commit: main
          body: |
            Created by job ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      - name: Output summary
        run: |
          echo "ðŸ”– New release - ${{ steps.release.outputs.html_url }}" >> $GITHUB_STEP_SUMMARY
